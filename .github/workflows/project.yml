name: Project CI

on:
  push:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run Django check
        run: python manage.py check

      - name: Run tests
        run: python manage.py test

      # âœ… ALWAYS collect logs
      - name: Prepare CI logs
        if: failure()
        run: |
          echo "CI_LOGS<<EOF" >> $GITHUB_ENV
          echo "Intentional CI failure detected" >> $GITHUB_ENV
          echo "Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # ðŸ¤– CALL YOUR AGENT REPO
      - name: Run CI Fix Agent
        if: failure()
        env:
          CI_LOGS: ${{ env.CI_LOGS }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
        run: |
          git clone https://github.com/vyaspurva20/ci-smart-agent.git
          pip install groq
          python ci-smart-agent/agent/agent.py
