name: Call CI Fix Agent

# üîê REQUIRED permissions to read artifacts from another workflow
permissions:
  actions: read
  contents: read

on:
  workflow_run:
    workflows: ["Project CI"]   # MUST exactly match your CI workflow name
    types:
      - completed

jobs:
  run-agent:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Download CI logs artifact from the FAILED workflow run
      - name: Download CI logs
        uses: actions/download-artifact@v4
        with:
          name: ci-logs
          path: logs
          run-id: ${{ github.event.workflow_run.id }}

      # 2Ô∏è‚É£ Prepare CI_LOGS environment variable
      - name: Prepare CI logs
        run: |
          echo "CI_LOGS<<EOF" >> $GITHUB_ENV
          cat logs/ci_logs.txt
          echo "EOF" >> $GITHUB_ENV

      # 3Ô∏è‚É£ Checkout AGENT repo using token
      - name: Checkout agent repo
        uses: actions/checkout@v4
        with:
          repository: vyaspurva20/ci-smart-agent   # üîÅ change if repo name differs
          token: ${{ secrets.AGENT_GITHUB_TOKEN }}
          path: agent

      # 4Ô∏è‚É£ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 5Ô∏è‚É£ Install agent dependencies
      - name: Install agent dependencies
        run: |
          python -m pip install --upgrade pip
          pip install groq

      # 6Ô∏è‚É£ Run the CI Fix Agent
      - name: Run CI Fix Agent
        env:
          CI_LOGS: ${{ env.CI_LOGS }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
        run: |
          python agent/agent.py
