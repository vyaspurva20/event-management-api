name: Call CI Fix Agent

on:
  workflow_run:
    workflows: ["Project CI"]   # MUST match CI workflow name
    types:
      - completed

jobs:
  run-agent:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Prepare CI logs
      - name: Prepare CI logs
        run: |
          echo "CI_LOGS<<EOF" >> $GITHUB_ENV
          echo "Workflow failed: ${{ github.event.workflow_run.name }}"
          echo "Run URL: ${{ github.event.workflow_run.html_url }}"
          echo "Conclusion: failure"
          echo "EOF" >> $GITHUB_ENV

      # 2Ô∏è‚É£ Checkout AGENT repo
      - name: Checkout agent repo
        uses: actions/checkout@v4
        with:
          repository: vyaspurva20/ci-bot-agent   # üîÅ CHANGE if name differs
          token: ${{ secrets.AGENT_GITHUB_TOKEN }}
          path: agent

      # 3Ô∏è‚É£ Setup Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 4Ô∏è‚É£ Install agent dependencies
      - name: Install agent dependencies
        run: |
          pip install groq

      # 5Ô∏è‚É£ Run agent
      - name: Run CI Fix Agent
        env:
          CI_LOGS: ${{ env.CI_LOGS }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
        run: |
          python agent/agent.py
