name: Call CI Fix Agent

# üîë REQUIRED permissions to read artifacts from workflow_run
permissions:
  actions: read
  contents: read

on:
  workflow_run:
    workflows: ["Project CI"]
    types:
      - completed

jobs:
  run-agent:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Download CI logs artifact from Project CI
      - name: Download CI logs
        uses: actions/download-artifact@v4
        with:
          name: ci-logs
          path: logs
          run-id: ${{ github.event.workflow_run.id }}
          repository: ${{ github.event.workflow_run.repository.full_name }}

      # 2Ô∏è‚É£ Prepare CI_LOGS env variable
      - name: Prepare CI logs
        run: |
          echo "CI_LOGS<<EOF" >> $GITHUB_ENV
          cat logs/ci_logs.txt
          echo "EOF" >> $GITHUB_ENV

      # 3Ô∏è‚É£ Checkout agent repo
      - name: Checkout agent repo
        uses: actions/checkout@v4
        with:
          repository: vyaspurva20/ci-smart-agent
          token: ${{ secrets.AGENT_GITHUB_TOKEN }}
          path: agent

      # 4Ô∏è‚É£ Setup Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 5Ô∏è‚É£ Install agent dependencies
      - name: Install agent dependencies
        run: |
          python -m pip install --upgrade pip
          pip install groq

      # 6Ô∏è‚É£ Run the CI Fix Agent
      - name: Run CI Fix Agent
        env:
          CI_LOGS: ${{ env.CI_LOGS }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
        run: |
          python agent/agent.py
